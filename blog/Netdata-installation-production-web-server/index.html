<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Netdata tutorial for Production Web Server (Nginx, PHP-fpm, MariaDB) | blog.py</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/blog/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/blog/css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-90109813-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-90109813-1');
</script>


    <link rel="shortcut icon" href="/blog/images/aperture.ico">

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed/"> 

    <!-- Social tags  -->
    <meta property="og:title"
    content="
      Netdata tutorial for Production Web Server (Nginx, PHP-fpm, MariaDB)
    ">

    <meta property="og:description"
        content="
            This post describes how to install and configure Netdata for a production server for a typical PHP webserver (Nginx, php, MariaDB)
        ">


    <meta property="og:url"
        content="https://odyslam.me/blog/Netdata-installation-production-web-server/" />

    <meta property="og:site_name" content="blog.py" />

    <meta property="og:locale" content="el_GR" />
    
    <meta name="twitter:site" content="@odysseas_lam" />
    
    <meta name="twitter:description" content="This post describes how to install and configure Netdata for a production server for a typical PHP webserver (Nginx, php, MariaDB)" />
    
    
  <!-- Article specific OG data -->
  <!-- The OG:Type dictates a number of other tags on posts. -->
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2020-03-30 00:00:00 +0300" />

  <!-- page.modified isn't a natural Jekyll property, but it can be added. -->
  

  <!-- Article section isn't a required property, but it can be good to have -->
  <meta property="article:section" content="devops" />

  <!-- I use the page.categories property for OG tags. -->
  

  <!-- I prefer the summary_large_image Twitter card for posts. -->
  <meta name="twitter:card" content="summary_large_image" />
  <!-- You, you're the creator. -->
  <meta name="twitter:creator" content="@odysseas_lam" />
  <!-- This property is for the article title, not site title. -->
  <meta name="twitter:title" content="Netdata tutorial for Production Web Server (Nginx, PHP-fpm, MariaDB)" />

  
    <meta property="og:image" content="https://pbs.twimg.com/profile_images/1146809342013988864/T0ULmki3_400x400.png" />
    <meta name="twitter:image" content="https://pbs.twimg.com/profile_images/1146809342013988864/T0ULmki3_400x400.png" />
  

  

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
  <p>
    print(<span class= "string">"You will possibly find posts about technology, politics, philosophy, self-improvement"</span>)
    <br>
   <br>
  </p>
  <p>
    print(<span class = "string">"Posts mainly in English, thank you for your interest"</span>)
  </p>
  <br>
  <p>
    print(<span class = "string">"BTW, this webserver is hosted on a actual Raspberry pi 4."</span>)
    <!-- <p>
            printf(<a href="https://." target="_blank"><span class="string">"https://<span class="reserved">%s</span>.<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <p>
    <!-- puts(<a href="/blogmisc/pubkey.gpg.txt" target="_blank"><span class="string">"5E12 9ABC C2A9 564B C048  2DF9 D327 0D10 BC71 CF75"</span></a>); -->
    <br>
  </p>
  </div>
</header>


<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a href="https://odyslam.me">>_ terminal/home</a></li>
          <li> | </li>
          <li><a href="/blog/">blog</a></li> 
          <li> | </li>
          <li><a href="https://twitter.com/odysseas_lam" target="_blank" >twitter</a></li>
          <li> | </li>
          <li> <a href="mailto:hi@odyslam.me">email</a></li>
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>Netdata tutorial for Production Web Server (Nginx, PHP-fpm, MariaDB)</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Mar 30, 2020
         ‚Ä¢ Odysseas Lamtzidis
        
        ‚Ä¢
        <span><a href="/blog/category/#2020" class="reserved">2020</a>,</span><span><a href="/blog/category/#tutorial" class="reserved">tutorial</a>,</span><span><a href="/blog/category/#linux" class="reserved">linux</a>,</span><span><a href="/blog/category/#devops" class="reserved">devops</a>,</span><span><a href="/blog/category/#netdata" class="reserved">netdata</a>,</span><span><a href="/blog/category/#open-source" class="reserved">open-source</a></span>
    </p>
  </header>

  <article class="post-content">
  <p>Created: Dec 05, 2019 | Updated: Jan 12, 2020 | Document Version: 0.3
<br />
<br /></p>
<h1 id="table-of-contents">Table of Contents</h1>

<ul>
  <li><a href="#table-of-contents">Table of Contents</a></li>
  <li><a href="#why">Why</a></li>
  <li><a href="#introduction">Introduction</a>
    <ul>
      <li><a href="#so-what-netdata-does">So what Netdata does?</a></li>
      <li><a href="#how-netdata-collectors-work">How netdata collectors work:</a></li>
      <li><a href="#requirements-for-the-use-case">Requirements for the use-case</a></li>
    </ul>
  </li>
  <li><a href="#installation">Installation</a>
    <ul>
      <li><a href="#netdata">Netdata</a></li>
      <li><a href="#firewall-issues">Firewall issues</a></li>
      <li><a href="#installation-using-package-manager">Installation using Package Manager</a></li>
      <li><a href="#nginx-proxy---security-alert">Nginx Proxy - Security Alert</a></li>
      <li><a href="#necessary-libraries">Necessary Libraries</a>
        <ul>
          <li><a href="#updateinstall-either-python-27-or-python-31">Update/Install either Python 2.7+ or Python 3.1+</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#important-note-on-python-version">Important Note on Python Version</a>
    <ul>
      <li><a href="#install-pip-python-package-manager">Install PiP (Python Package Manager)</a></li>
      <li><a href="#install-collector-libraries">Install Collector Libraries:</a>
        <ul>
          <li><a href="#ubuntu">Ubuntu</a></li>
          <li><a href="#centos">CentOS</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#netdata-configuration">Netdata Configuration</a>
    <ul>
      <li><a href="#general-configuration">General Configuration</a></li>
      <li><a href="#collectors-data-collection">Collectors (Data Collection)</a>
        <ul>
          <li><a href="#general-information">General Information</a></li>
          <li><a href="#chosen-collectors">Chosen Collectors:</a></li>
          <li><a href="#notes-on-editing-the-configuration-files">Notes on editing the configuration files:</a></li>
          <li><a href="#db-engine">DB engine</a></li>
        </ul>
      </li>
      <li><a href="#health--alarms">Health &amp; Alarms</a>
        <ul>
          <li><a href="#notifications">Notifications</a></li>
          <li><a href="#email-configuration">Email Configuration</a></li>
        </ul>
      </li>
      <li><a href="#streaming">Streaming</a>
        <ul>
          <li><a href="#master-node">Master Node</a></li>
          <li><a href="#slave-node">Slave Node</a></li>
        </ul>
      </li>
      <li><a href="#registry">Registry</a></li>
      <li><a href="#backends-long-term-storage">Backends (Long-term Storage)</a>
        <ul>
          <li><a href="#prometheus-installation">Prometheus Installation</a></li>
          <li><a href="#prometheus-configuration">Prometheus Configuration</a></li>
          <li><a href="#test-prometheus">Test Prometheus</a></li>
          <li><a href="#prometheus-service">Prometheus Service</a></li>
          <li><a href="#prometheus-and-high-availability">Prometheus and High-Availability</a></li>
          <li><a href="#grafana">Grafana</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#acknowledgement">Acknowledgement</a></li>
  <li><a href="#comments">Comments</a></li>
</ul>

<h1 id="why">Why</h1>

<p>A while back I discovered <a href="https://netdata.cloud">Netdata</a> and I was truly fascinated by it‚Äôs take on system monitoring for two main reasons. It was extremely lightweight, something of great usefulness to me, an IoT enthusiast, as it proved to be a  very useful tool to debug IoT devices, such as the Raspberry pi.</p>

<p>On a Raspberry pi zero W, it consumes as little as 10% of the cpu, without any optimization whatsoever and update frequency of 1 second. <strong>Crazy huh?</strong></p>

<p>Another aspect that I enjoyed as a newcomer to the world of <em>Devops</em> was the intrinsic easiness of both the installation and customization of the platform. It‚Äôs truly a <em>fire and forget</em> application that is configured and programmed in such as way that the default settings will be adequate for a large number of users, myself included.</p>

<p>This fascination and the fact that I had just finished my Integrated Master‚Äôs diploma ,(thus looking to break into the startup world), led me to contribute a bit of docs and code, as a good open source citizen.</p>

<p>Wanting to dig further, I was extremely fortunate to be introduced to a sys-admin at the University of Patras, named Spiros. Spiros and I, installed and configured Netdata on a production server for the University of Patras. This post is an attempt to distill what we learned.</p>

<p><em>This post describes how to install and configure Netdata for a production server for a typical PHP webserver (Nginx, php, MariaDB).</em></p>

<p><strong>It was originally written back in January, but it is published now for the first time.</strong></p>

<h1 id="introduction">Introduction</h1>

<p>This post is intended for the purpose of onboarding a production web-server to the Netdata platform, introducing a new era to metrics and performance monitoring. Netdata is built around 4 main principles:</p>

<ul>
  <li><strong>Per second</strong> data collection for all metrics.</li>
  <li>Collection &amp; Visualisation of metrics from <strong>all possible</strong> sources</li>
  <li>Meaningful presentation of metrics, optimised for visual anomaly detection</li>
  <li><strong>Preconfigured</strong>, fire (install) and forget!</li>
</ul>

<blockquote>
  <p>Netdata decentralizes monitoring completely. Each Netdata node is autonomous. It collects metrics locally, it stores them locally, it runs checks against them to trigger alarms locally, and provides an API for the dashboards to visualize them. <strong>Horizontal Scale</strong></p>
</blockquote>

<h3 id="so-what-netdata-does">So what Netdata does?</h3>

<ol>
  <li>Metrics are auto-detected, so for 99% of the cases data collection works out of the box.</li>
  <li>Metrics are converted to human readable units, right after data collection, before storing them into the database.</li>
  <li>Metrics are structured, organized in charts, families and applications, so that they can be browsed.</li>
  <li>Dashboards are automatically generated, so all metrics are available for exploration immediately after installation.</li>
  <li>Dashboards are not just visualizing metrics; they are a tool, optimized for visual anomaly detection.</li>
  <li>Hundreds of pre-configured alarm templates are automatically attached to collected metrics.</li>
</ol>

<p><img src="https://i.imgur.com/hcoIwoB.png" alt="Netdata%20guide%20for%20Production%20Web%20Server%20Nginx%20PHP%20/Untitled.png" /></p>

<h3 id="how-netdata-collectors-work">How netdata collectors work:</h3>

<p>Netdata uses internal and external plugins to collect data. Internal plugins run within the Netdata daemon, while external plugins are independent processes that send metrics to Netdata over pipes. There are also plugin orchestrators, which are external plugins with one or more data collection modules.</p>

<h2 id="requirements-for-the-use-case">Requirements for the use-case</h2>

<ul>
  <li><strong>History:</strong>
    <ul>
      <li>Period: 1 year</li>
      <li>Granularity: (average)5min</li>
      <li>Data points: cpu, net traffic, ram (systemwide, per application)</li>
    </ul>
  </li>
  <li><strong>System:</strong> Ubuntu 18.04.3 LTS</li>
  <li><strong>VM:</strong> Yes</li>
  <li><strong>Applications:</strong>
    <ul>
      <li>Ngingx</li>
      <li>phpfm</li>
      <li>drupal</li>
      <li>mariaDB (mysql, innodb style)</li>
    </ul>
  </li>
  <li><strong>Alarms:</strong>
    <ul>
      <li>Critical: downtime (uptime monitor)</li>
      <li>Normal: uptime monitor, unusual senarios (e.g 70% cpu. 99% i/o filesystem)</li>
      <li>Medium: email</li>
    </ul>
  </li>
  <li><strong>Setup:</strong>
    <ul>
      <li>Local registry</li>
      <li>2 linux VMs webserver, one for upatras.gr, one for various minor sites</li>
      <li>situated in the same secure network, no need for vpn or authentication</li>
    </ul>
  </li>
</ul>

<h1 id="installation">Installation</h1>

<p>In this section we go through the installation of the netdata platform and all the required libaries, packages and third party programs that will enable the monitoring according to the requirements.</p>

<p>This installation will be replicated to both the machines that will host a web-server, one will work as a slave that will forward metrics to the main machine where all the processing and storage will be conducted. It is explained in the <strong>Streaming section.</strong></p>

<h2 id="netdata">Netdata</h2>

<p>There are multiple ways to install netdata, but the user is advised to use the one-line script that is provided by netdata. According to the requirements, this is the optimal route.</p>

<p>With the one-liner below, you install netdata and all the dependencies. You also agree that Netdata will aggregate anonymous statistics (such as OS version) that is necessary for rapid product development and discovery (prioritise OS binaries, decide features etc.)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash &lt;<span class="o">(</span>curl <span class="nt">-Ss</span> <span class="o">[</span>https://my-netdata.io/kickstart.sh]<span class="o">(</span>https://my-netdata.io/kickstart.sh<span class="o">))</span> <span class="nt">--no-updates</span> <span class="nt">--stable-channel</span>
</code></pre></div></div>

<p><strong>comments:</strong></p>

<p>no-updates: Prevent automatic updates of any kind.</p>

<p>stable-channel: Automatically update only on the release of new major versions (thus install latest stable release)</p>

<p>To inspect the installation url, the use can download it from <a href="https://my-netdata.io/kickstart.sh">here</a>.</p>

<p>Now that Netdata is (hopefully) installed, please head over to <a href="http://localhost:19999">http://localhost:19999</a> to verify correct installation.</p>

<h2 id="firewall-issues">Firewall issues</h2>

<p>If you can‚Äôt connect, it‚Äôs possible that you have a firewall installed and that you have to open the port <code class="highlighter-rouge">19999</code>.  Belowdav you can find relevant information and commands for Ubuntu &amp; CentOS.</p>

<p><strong>Ubuntu:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ufw allow 19999/tcp
</code></pre></div></div>

<p><strong>CentOS:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>firewall-cmd <span class="nt">--permanent</span> <span class="nt">--add-port</span> 19999/tcp
</code></pre></div></div>
<p>Don‚Äôt forget to enable the netdata service using <code class="highlighter-rouge">sudo systemctl enable netdata</code></p>

<p><strong>All Installation methods:</strong> <a href="https://docs.netdata.cloud/packaging/installer/">https://docs.netdata.cloud/packaging/installer/</a></p>

<h2 id="installation-using-package-manager">Installation using Package Manager</h2>

<p>In a production environment, it is a good practice to use the Package Manager to install Netdata. Please do so by using the Package Manager of the distribution.</p>

<p>Before Installing Netdata from the Package Manager, we need to add the Netdata Repository from <a href="https://packagecloud.io/netdata/netdata">PackageCloud</a> into the <em>system package sources</em>.</p>

<p>Run the following code to add the Repository into your <em>system‚Äôs package sources</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> https://packagecloud.io/install/repositories/netdata/netdata/script.deb.sh | <span class="nb">sudo </span>bash
</code></pre></div></div>

<p>Now we can install netdata (e.g using <code class="highlighter-rouge">apt-get install</code> in Ubuntu):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>upgrade
<span class="nb">sudo </span>apt-get <span class="nb">install </span>netdata
</code></pre></div></div>
<h2 id="nginx-proxy---security-alert">Nginx Proxy - Security Alert</h2>

<p>For increased security, it is advised that you configure Netdata to be only accessible from <a href="http://localhost">localhost</a> and <em>proxy</em> the connection through an NginX Reverse Proxy server. Please follow the <a href="Python3">guide</a> to set up the reverse proxy.</p>

<h2 id="necessary-libraries">Necessary Libraries</h2>

<p>As per the uproduction web-server scenario requirements, we need to install some external libraries in order for the plugins that enable the data collection (collectors) can be used by netdata.</p>

<p>Although netdata supports plugins from 4 different ecosystems (Bash, Python, NodeJS, Golang), we will be using <strong>Python Plugins</strong> as they cover our needs and are the most battle-tested.</p>

<p><strong>News Bullet:</strong>  Netdata is gradually implementing all the python add-ons to Golang, as Golang offers better performance (<strong>which is critical to minimise netdata‚Äôs footprint</strong>). Although Python plugins will still function as expected, after the transition, new versions of the plugins (e.g with more metrics) will likely  appear as Go plugins.</p>

<h3 id="updateinstall-either-python-27-or-python-31">Update/Install either Python 2.7+ or Python 3.1+</h3>

<p>To test currently installed python version:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#python 2</span>
python <span class="nt">-V</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#python 3 </span>
python3 <span class="nt">-V</span>
</code></pre></div></div>
<h1 id="important-note-on-python-version">Important Note on Python Version</h1>

<p>Currently, Netdata uses the system‚Äôs default python version. Thus, for <strong>most systems (e.g Ubuntu), Netdata will use Python2.7.</strong> If python2.7 is the default one for your system, please install all the libraries for Python2.7.</p>

<p>All systems have a certain Python version already pre-installed. It is advised to use that one for the rest of the tutorial and not install a new one.</p>

<h3 id="install-pip-python-package-manager">Install PiP (Python Package Manager)</h3>

<p>Before proceeding, we will install PIP, a <strong>necessary</strong> Package Manager for all Python libraries.</p>

<p>Depending on the python version that we will be using, install PIP using the Package Manager of the distribution.</p>

<p><strong>Python2:</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>python-pip
pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip <span class="c">#update pip to latest version</span>
</code></pre></div></div>
<p><strong>Python3:</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>python3-pip
pip <span class="nb">install</span> <span class="nt">--upgrade</span> pip <span class="c">#update pip to latest version</span>
</code></pre></div></div>
<h3 id="install-collector-libraries">Install Collector Libraries:</h3>

<p><strong>MariaDB(Mysql):</strong></p>

<p>To monitor the MariaDB server, we will be needing the <em>python library</em> <code class="highlighter-rouge">python-mysqldb</code>. Please follow the instructions bellow to install the package <strong>system-wide.</strong></p>

<p>It is worth mentioning that depending on your setup, it is possible that you will be needing to use <code class="highlighter-rouge">sudo pip</code>. In that case, please use the -H flag as follows: <code class="highlighter-rouge">sudo -H</code>. It is needed to force pip to install the package to the system‚Äôs home directory, thus making the package available system-wide.</p>

<h4 id="ubuntu">Ubuntu</h4>

<p>Depending on whether you use Python2 or Python3, the installation of the required packages and libraries is different. The packages are required so that the Python Library that interfaces with MariaDB can function properly.</p>

<p><strong>Python2</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>default-libmysqlclient-dev
<span class="nb">sudo </span>apt-get <span class="nb">install </span>python-dev 
pip <span class="nb">install </span>mysqlclient 
</code></pre></div></div>
<p><strong>Python3</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>default-libmysqlclient-dev
<span class="nb">sudo </span>apt-get <span class="nb">install </span>python3-dev 
pip3 <span class="nb">install </span>mysqlclient
</code></pre></div></div>

<h4 id="centos">CentOS</h4>

<p><strong>Python3</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>mariadb-devel
pip3 <span class="nb">install </span>mysqlclient
</code></pre></div></div>
<p><strong>Python2</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>mariadb-devel
pip <span class="nb">install </span>mysqlclient 
</code></pre></div></div>
<p><strong>Github page:</strong> <a href="https://github.com/PyMySQL/mysqlclient-python">https://github.com/PyMySQL/mysqlclient-python</a></p>

<p><strong>Docs:</strong> <a href="https://mysqlclient.readthedocs.io/">https://mysqlclient.readthedocs.io/</a></p>

<h1 id="netdata-configuration">Netdata Configuration</h1>

<p>Now that everything is installed, you can restart netdata by running <code class="highlighter-rouge">sudo systemctl restart netdata</code>and head over to the dashboard <code class="highlighter-rouge">http:&lt;netdata_host_ip&gt;:19999</code>. Netdata automatically detects data sources and enable plugins.</p>

<h2 id="general-configuration">General Configuration</h2>

<p>The configuration of the netdata agent is conducted through a helper script which is found at:</p>

<p><code class="highlighter-rouge">/etc/netdata/edit-config</code>. It is possible that <code class="highlighter-rouge">sudo</code> is needed to use the script as the script fetches the default configuration, opens it for the user to edit and then saves it in <code class="highlighter-rouge">/etc/netdata</code>.</p>

<p>The main configuration file is named: <strong>netdata.conf</strong>.</p>

<p>The <code class="highlighter-rouge">netdata.conf</code> file is broken up into various sections, such as [global], [web], [registry], and more. By default, most options are commented, so you‚Äôll have to uncomment them (remove the #) and restart netdata for Netdata to recognise your change.</p>

<p><strong>We will be leaving the configuration at default for an initial testing period</strong>, before we proceed to any modifications to address specific needs. Bellow, the user can find all relevant documentation for easy access.</p>

<p>One metrics we do need to change, is the storage capacity of the <strong>dbengine,</strong> which is the default saving mechanism and our choice as per the requirements.</p>

<p>Note that there are <strong>several options</strong> regarding the <strong>mechanism</strong> with which netdata will <strong>save data,</strong> including the dbengine and a Round-Robin in-memory only database. For more information: https://docs.netdata.cloud/database</p>

<h2 id="collectors-data-collection">Collectors (Data Collection)</h2>

<p>Netdata supports¬†<strong>internal</strong>¬†and¬†<strong>external</strong>¬†data collection plugins:</p>

<ul>
  <li><strong>internal</strong>¬†plugins are written in¬†<code class="highlighter-rouge">C</code>¬†and run as threads inside the¬†<code class="highlighter-rouge">netdata</code>¬†daemon.</li>
  <li><strong>external</strong>¬†plugins may be written in any computer language and are spawn as independent long-running processes by the¬†<code class="highlighter-rouge">netdata</code>¬†daemon. They communicate with the¬†<code class="highlighter-rouge">netdata</code>¬†daemon via¬†<code class="highlighter-rouge">pipes</code>¬†(<code class="highlighter-rouge">stdout</code>¬†communication).</li>
</ul>

<p>To minimize the number of processes spawn for data collection, Netdata also supports¬†<strong>plugin orchestrators</strong>.</p>

<ul>
  <li>
    <p><strong>plugin orchestrators</strong>¬†are external plugins that do not collect any data by themeselves. Instead they support data collection¬†<strong>modules</strong>¬†written in the language of the orchestrator. Usually the orchestrator provides a higher level abstraction, making it ideal for writing new data collection modules with the minimum of code.</p>

    <p>Currently Netdata provides plugin orchestrators BASH v4+¬†<a href="https://docs.netdata.cloud/collectors/charts.d.plugin/">charts.d.plugin</a>, node.js¬†<a href="https://docs.netdata.cloud/collectors/node.d.plugin/">node.d.plugin</a>¬†and python v2+ (including v3)¬†<a href="https://docs.netdata.cloud/collectors/python.d.plugin/">python.d.plugin</a>.</p>
  </li>
</ul>

<p>We will be using the Python plugin orchestrator, each of the collectors states below is in essence a module of the Python.d plugin.</p>

<h3 id="general-information">General Information</h3>

<p>When Netdata starts, it auto-detects dozens of data sources, such as database servers, web servers, and more. To auto-detect and collect metrics from a service or application you just installed, you need to restart Netdata.</p>

<p><strong>Download and install all the software that you want to monitor (in our case: nginx, PHP-fmp, MariaDB) prior to the netdata installation, to leverage automatic discovery)</strong></p>

<p>We can configure both internal and external plugins, along with the individual modules.</p>

<ul>
  <li>In¬†<code class="highlighter-rouge">netdata.conf</code>,¬†<code class="highlighter-rouge">[plugins]</code>¬†section: Enable or disable internal or external plugins with¬†<code class="highlighter-rouge">yes</code>¬†or¬†<code class="highlighter-rouge">no</code>.</li>
  <li>In¬†<code class="highlighter-rouge">netdata.conf</code>,¬†<code class="highlighter-rouge">[plugin:XXX]</code>¬†sections: Each plugin has a section for changing collection frequency or passing options to the plugin.</li>
  <li>In¬†<code class="highlighter-rouge">.conf</code>¬†files for each external plugin: Enable/Disable specific modules or set plugin specific configurations. For example, at¬†<code class="highlighter-rouge">/etc/netdata/python.d.conf</code>.</li>
  <li>In¬†<code class="highlighter-rouge">.conf</code>¬†files for each module. Set module specific configurations, such as the metrics endpoint. : For example, at¬†<code class="highlighter-rouge">/etc/netdata/python.d/nginx.conf</code>.</li>
</ul>

<p>We will be leaving the configurations at default for the testing period. In case you have installed an application with non-standard settings (e.g different socket location) please do make the proper change in the appropriate <code class="highlighter-rouge">.conf</code> file. Otherwise, no configuration is needed (unless explicitly stated in this guide).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Example</span>
<span class="nb">sudo</span> /etc/netdata/edit-config python.d/nginx.conf
</code></pre></div></div>

<h3 id="chosen-collectors">Chosen Collectors:</h3>

<p>As per the requirements of production web-server, the following plugins were chosen:</p>

<ul>
  <li><strong>web_log:</strong> Parses the log files of known servers (e.g nginx) and detects irregularities</li>
  <li><strong>mysql:</strong> connects to a mysql database and fetches various metrics</li>
  <li><strong>php-FPM:</strong> Uses the /metrics endpoint of a PHP-FPM powered server and fetches metrics</li>
  <li><strong>nginx:</strong> Uses the metrics endpoint( socket, HTTP endpoint) and fetches metrics</li>
</ul>

<h3 id="notes-on-editing-the-configuration-files">Notes on editing the configuration files:</h3>

<p>Python plugins use YAML files to be configured, and one of the most important common configurable variable, is the resource address that each plugin will reach to gather statistics.</p>

<p>To facilitate configuration, most Netdata plugins have already pre-configured a number of possible endpoints for each plugin. For example, <code class="highlighter-rouge">mysql</code> searches on multiple directories for the right  <code class="highlighter-rouge">Unix socket</code> It does so by defining different <code class="highlighter-rouge">jobs</code>, each <code class="highlighter-rouge">job</code> for one endpoint .</p>

<p>Note that if two or more jobs have the same <code class="highlighter-rouge">name</code>, only one will run. Meaning that <strong>the plugin will use the endpoint for which it‚Äôs job was the first one to succeed in retrieving information.</strong></p>

<p>Thus, when configuring the plugins, <strong>you can edit only one job to point it to the right direction</strong> (for example, if you have changed the default directory for the <code class="highlighter-rouge">nginx_status_page</code>.</p>

<p>It is also advised to change the name of <em>all</em> the jobs to the desired name (that will be used by the dashboard) so that you don‚Äôt have to find out specifically which job is the one that is activated by the plugin.</p>

<p>üìç  <strong>web_log</strong></p>

<p>Parses the log file of various web servers (nginx, apache, gunicord, etc.) to detect the following scenarios:</p>

<ul>
  <li>too many redirects</li>
  <li>too many bad requests</li>
  <li>too many internal server errors</li>
  <li>
    <p>unreasonably too many requests</p>
  </li>
  <li>unreasonably few requests</li>
  <li>unreasonably slow responses</li>
  <li>too few successful responses</li>
</ul>

<p>üîß Edit the configuration file to point the collector to the correct <strong>weblog metrics endpoint (</strong> the logs of your web server e.g apache, nginx, etc. )<strong>.</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/netdata/edit-config python.d/web_log.conf
</code></pre></div></div>
<p>Make sure that web_server logs and the relevant directory is accessible by the user <code class="highlighter-rouge">netdata</code></p>

<p>üìÉ <em>docs page:</em> <a href="https://docs.netdata.cloud/collectors/python.d.plugin/web_log/">https://docs.netdata.cloud/collectors/python.d.plugin/web_log/</a></p>

<p>üìç  <strong>mysql</strong></p>

<p>It monitors one or many mysql servers. To function as intended it requires a python library (as mentioned above) and a <strong>netdata user</strong> to access the database and gather metrics.</p>

<p>To create the¬†<code class="highlighter-rouge">netdata</code>¬†user, execute the following in the MySQL shell:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">user</span> <span class="s1">'netdata'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="k">grant</span> <span class="k">usage</span> <span class="k">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'netdata'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="n">flush</span> <span class="k">privileges</span><span class="p">;</span>
</code></pre></div></div>

<p>üîß Edit the configuration file to point the collector to the correct <strong>mysql metrics endpoint.</strong></p>

<blockquote>
  <p>üìçPlease note that the default settings probably already cover your use-case.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/netdata/edit-config python.d/mysql.conf
</code></pre></div></div>

<p>üìÉ <em>docs page:</em> <a href="https://docs.netdata.cloud/collectors/python.d.plugin/mysql/">https://docs.netdata.cloud/collectors/python.d.plugin/mysql/</a></p>

<p>üìç  <strong>PHP-FPM:</strong></p>

<p>This module will monitor one or more php-fpm instances depending on configuration.</p>

<p>üîß Edit the configuration file to point the collector to the correct <strong>PHP-FPM metrics endpoint.</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/netdata/edit-config python.d/phpfpm.conf
</code></pre></div></div>

<p>üìÉ<em>docs page:</em> <a href="https://docs.netdata.cloud/collectors/python.d.plugin/phpfpm/">https://docs.netdata.cloud/collectors/python.d.plugin/phpfpm/</a></p>

<p>üìç <strong>nginx:</strong></p>

<p>This module will monitor one or more nginx servers depending on configuration. Servers can be either local or remote.</p>

<p>üîß Edit the configuration file to point the collector to the correct <strong>nginx metrics endpoint.</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/netdata/edit-config python.d/nginx.conf
</code></pre></div></div>

<p>üìÉ<em>docs page:</em> <a href="https://docs.netdata.cloud/collectors/python.d.plugin/nginx/">https://docs.netdata.cloud/collectors/python.d.plugin/nginx/</a></p>

<p><strong>httpcheck:</strong></p>

<p>Module monitors remote http server for availability and response time.</p>

<p>The user must edit the <code class="highlighter-rouge">.conf</code> file to point it to the web server‚Äôs location.  You can use regex expression, as stated in the configuration file, in order for the plugin to <strong>search a specific string</strong> in the website.</p>

<p>This is handful in case the PHP server has crashed, so nginx does not return the proper website, but rather the nginx home screen. HTTP (200) is returned either way, meaning that httpcheck <em>without</em> regex can‚Äôt tell the difference.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/netdata/edit-config python.d/httpcheck.conf
</code></pre></div></div>

<p>üìÉ<em>docs page:</em> <a href="https://docs.netdata.cloud/collectors/python.d.plugin/httpcheck/">https://docs.netdata.cloud/collectors/python.d.plugin/httpcheck/</a></p>

<hr />

<h3 id="db-engine">DB engine</h3>

<p>DB engine is the custom database implemented and used by netdata. It stores most recent data in-memory and ‚Äúspills‚Äù historical data into the disk, compressing them to increase storage performance even further.  Notably, it is optimised for HDDs, offering performance that is acceptable versus the more efficient SSDs.</p>

<p>The configuration variables that are of interest to us are the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[global]
    page cache size = 32
    dbengine disk space = 256
</code></pre></div></div>
<p><code class="highlighter-rouge">page cache size</code>¬†sets the maximum amount of RAM (in MiB) the database engine will use for caching and indexing.¬†<code class="highlighter-rouge">dbengine disk space</code>¬†sets the maximum disk space (again, in MiB) the database engine will use for storing compressed metrics.</p>

<p>These default settings will retain about <strong>a day‚Äôs worth</strong> of metrics when Netdata collects roughly <strong>4,000 metrics every second.</strong> If you increase either¬†<code class="highlighter-rouge">page cache size</code>¬†or¬†<code class="highlighter-rouge">dbengine disk space</code>, Netdata will retain even more historical metrics.</p>

<p>The use-case of production web-server involves roughly 2,000 metrics per second, thus the default settings will save 2 days worth of data. <strong>For a retention period of 1 week, the following settings are advised.</strong></p>

<p>When using the dbengine, the <code class="highlighter-rouge">history</code> configuration variable is irrelevant, please ignore it.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[global]
    page cache size = 32
    dbengine disk space = 1024 
</code></pre></div></div>
<p>Note that <strong>both fields affect the memory footprint</strong> of the <code class="highlighter-rouge">dbengine</code> and as a result netdata in general. For the specific use-case tests were conducted and was decided that the change in memory consumption <strong>is not noteworthy</strong>. For more info: https://docs.netdata.cloud/database/engine/#memory-requirements</p>

<p>üôè  <em>With the database engine active, you can back up your /var/cache/netdata/dbengine/ folder to another location for redundancy.</em></p>

<p><strong>dbengine docs:</strong> <a href="https://docs.netdata.cloud/database/engine">https://docs.netdata.cloud/database/engine</a></p>

<p><strong>dbengine &amp; history retention period:</strong> <a href="https://docs.netdata.cloud/docs/tutorials/longer-metrics-storage/">https://docs.netdata.cloud/docs/tutorials/longer-metrics-storage/</a></p>

<hr />

<h2 id="health--alarms">Health &amp; Alarms</h2>

<p>Each Netdata node runs an independent thread evaluating health monitoring checks. This thread has lock free access to the database, so that it can operate as a watchdog.</p>

<p>Netdata also supports alarm¬†<strong>templates</strong>, so that an alarm can be attached to all the charts of the same context (i.e. all network interfaces, or all disks, or all mysql servers, etc.).</p>

<p>Each alarm can execute a single query to the database using statistical algorithms against past data, but alarms can be combined. So, if you need 2 queries in the database, you can combine 2 alarms together (both will run a query to the database, and the results can be combined).</p>

<p>For the given use case, we will be using the stock alarms as they cover all the scenarios. The user is advised to adjust the alarms in the future for more fine-grained controls.</p>

<p>To edit the configuration files for the alarms of each plugin, we will use the <code class="highlighter-rouge">edit-config</code> command, like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Example for editing the alarms of the httpcheck plugin</span>
<span class="nb">sudo</span> /etc/netdata/edit-config health.d/httpcheck.conf
</code></pre></div></div>
<p>To get an easy overview over the active alarms, head over to the <strong>dashboard</strong> and click on the <strong>Alarms section</strong> at the top. After clicking the category <strong>all</strong>, you can overview the activated alarms, their configuration and an apt description.</p>

<h3 id="notifications">Notifications</h3>

<p>An important aspect of the alarms component is the notification functionality. Netdata is able to inform the user on important events, via multiple mediums, from e-mail to discord integration.</p>

<p>To configure the alarming configuration (such as email recipient, etc.) we edit the following configuration file:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /etc/netdata/edit-config health_alarm_notify.conf
</code></pre></div></div>
<p>Since we will be using  <code class="highlighter-rouge">Email</code>, we only edit the following variables inside the configuration file, moreover if we want to enable the notifications <strong>ONLY</strong> for critical alarms, please follow the mentioned structure:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DEFAULT_RECIPIENT_EMAIL="YOUR_EMAIL"
# to receive only critical alarms, set it to "YOUR_EMAIL|critical"
</code></pre></div></div>
<h3 id="email-configuration">Email Configuration</h3>

<p>To configure email with netdata, the user needs to configure a terminal email client. <code class="highlighter-rouge">sendemail</code> is advised as is one of the most common clients and also the default choice for netdata.</p>

<p><strong>To configure please follow the instructions:</strong> <a href="https://dbaron.org/linux/sendmail">https://dbaron.org/linux/sendmail</a></p>

<p>For more information on the syntax of the alarms (in order to fine tune the alarm criteria or add new alarms), please visit the health.d docs and the badges doc (they use same structure).</p>

<p><strong>Health.d:</strong> <a href="https://docs.netdata.cloud/health/">https://docs.netdata.cloud/health/</a></p>

<p><strong>Badges:</strong> <a href="https://docs.netdata.cloud/web/api/badges/">https://docs.netdata.cloud/web/api/badges/</a></p>

<h2 id="streaming">Streaming</h2>

<p>Each Netdata is able to replicate/mirror its database to another Netdata, by streaming collected metrics, in real-time to it. This is quite different to data archiving to third party time-series databases.</p>

<p>When Netdata streams metrics to another Netdata, the receiving one is able to perform everything a Netdata instance is capable of:</p>

<ul>
  <li>visualize them with a dashboard</li>
  <li>run health checks that trigger alarms and send alarm notifications</li>
  <li>archive metrics to a backend time-series database</li>
</ul>

<p>Per the requirements, we will be using a <strong>slave-master setup</strong>, where a node will behave as the master node and gateway to the system, while each slave will only serve as aggregator of data.</p>

<p><strong>In essence the Master Netdata node will have 2 databases from which it will draw charts and raise alarms.</strong></p>

<ol>
  <li>The first database is from the machine where the master node is installed</li>
  <li>The second database is from the machine where the slave node is installed</li>
</ol>

<h3 id="master-node">Master Node</h3>

<p>When setting up the Master Node, we will be configuring settings for API_KEYS and not for distinct slaves, meaning that master node will treat each slave that is configured with an identical API_KEY, the same.</p>

<p>Depending on the use case, we might want to have different settings for different slave machines (e.g different history retention policy). We generate <code class="highlighter-rouge">N API_KEYS</code> for <code class="highlighter-rouge">N</code> distinct <code class="highlighter-rouge">slave groups</code>. All the <code class="highlighter-rouge">slaves</code> that belong to the same <code class="highlighter-rouge">slave group</code> will be treated the same by the <code class="highlighter-rouge">Master Node</code>.</p>

<p>To generate <code class="highlighter-rouge">N API_KEYS</code>, we run N times the command: <code class="highlighter-rouge">uuidgen</code>. In our case, we generate only one (1) <code class="highlighter-rouge">API_KEY</code>.</p>

<p>Now it is time to setup the <strong>Master Node</strong>:</p>

<ol>
  <li>Setup netdata (without installing any extra libraries, as Netdata Master will only monitor the system and itself, serving as the central hub of the metrics from all the slaves).
    <ol>
      <li>Note that the Master Node will have extra requirements in RAM and disk storage as it will retain 2 databases for the slaves (2000 metrics/s) and 1 database for  the Master (1500 metrics/s), for one week.</li>
      <li>For more information on the DBengine‚Äôs requirements, please read <a href="https://github.com/netdata/netdata/blob/master/docs/tutorials/longer-metrics-storage.md">here</a> and <a href="https://docs.netdata.cloud/database/engine/">here</a>.</li>
    </ol>
  </li>
  <li>edit <code class="highlighter-rouge">stream.conf</code> and set <code class="highlighter-rouge">[stream].enabled: yes</code>
    <ol>
      <li><code class="highlighter-rouge">sudo /etc/netdata/edit-config stream.conf</code></li>
      <li>The <code class="highlighter-rouge">API_KEY</code> mentioned bellow is the <code class="highlighter-rouge">API_KEY</code> we generated using <code class="highlighter-rouge">uuidgen</code>.
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[API_KEY] 
 enabled = yes
 default history = 3600
 default memory mode = dbengine
 health enabled by default = auto
 allow from = *
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>For the initial testing period we wont‚Äôt be editing anything else. You can return later to customise it according to your specific needs.</li>
  <li>Since both the machines belong to the same secured network, we won‚Äôt be needing authentication and TLS support.</li>
</ol>

<p>You can find in-detail explanation of all the available configuration options for the streaming functionality in the docs.</p>

<p>üìÉ<em>docs:</em> <a href="https://docs.netdata.cloud/streaming/">https://docs.netdata.cloud/streaming/</a></p>

<h3 id="slave-node">Slave Node</h3>

<p><strong>The setup of each slave Node is identical:</strong></p>

<ol>
  <li>Setup netdata and the required libraries according to the guide above
    <ol>
      <li>When setting up the dbengine, use the default settings that will allow close to 2 days word of data to be stored in the slave for redundancy.</li>
    </ol>
  </li>
  <li>edit <code class="highlighter-rouge">stream.conf</code>
    <ol>
      <li>Use the <code class="highlighter-rouge">API_KEY</code> that was generated in the Master Slave phase.</li>
      <li><code class="highlighter-rouge">sudo /etc/netdata/stream.conf</code>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[stream]
 enabled = yes 
 destination = IP:PORT #Master
 api key = API_KEY #generated in step (1)
</code></pre></div>        </div>
        <p>Now each slave node is configured to stream the entirety of the metrics that it collects to the master node.</p>
      </li>
    </ol>
  </li>
</ol>

<h2 id="registry">Registry</h2>

<p>Using Netdata, your monitoring infrastructure is embedded on each server, limiting significantly the need of additional resources. Netdata is blazingly fast, very resource efficient and utilizes server resources that already exist and are spare (on each server). This allows¬†<strong>scaling out</strong>¬†the monitoring infrastructure.</p>

<p>However, the Netdata approach introduces a few new issues that need to be addressed, one being¬†<strong>the list of Netdata we have installed</strong>, i.e. the URLs our Netdata servers are listening.</p>

<p>To solve this, Netdata utilizes a¬†<strong>central registry</strong>. This registry, together with certain browser features, allow Netdata to provide unified cross-server dashboards.</p>

<p><strong>The registry keeps track of 4 entities:</strong></p>

<ol>
  <li>
    <p><strong>machines</strong>: i.e. the Netdata installations (a random GUID generated by each Netdata the first time it starts; we call this¬†<strong>machine_guid</strong>)</p>

    <p>For each Netdata installation (each¬†<code class="highlighter-rouge">machine_guid</code>) the registry keeps track of the different URLs it is accessed.</p>
  </li>
  <li>
    <p><strong>persons</strong>: i.e. the web browsers accessing the Netdata installations (a random GUID generated by the registry the first time it sees a new web browser; we call this¬†<strong>person_guid</strong>)</p>

    <p>For each person, the registry keeps track of the Netdata installations it has accessed and their URLs.</p>
  </li>
  <li>
    <p><strong>URLs</strong>¬†of Netdata installations (as seen by the web browsers)</p>

    <p>For each URL, the registry keeps the URL and nothing more. Each URL is linked to¬†<em>persons</em>¬†and¬†<em>machines</em>.</p>
  </li>
  <li>
    <p><strong>accounts</strong>: i.e. the information used to sign-in via one of the available sign-in methods. Depending on the method, this may include an email, an email and a profile picture. <strong>Only applicable via cloud log-in.</strong></p>
  </li>
</ol>

<p><strong>Local Registry</strong></p>

<p>For security purposes and per the production web-server requirements, we will be establishing an agent node as a local registry and then configure all the netdata nodes to advertise themselves to that registry. This way, the user will be able to access the local registry and easily navigate towards all the available netdata instances.</p>

<p>üîß To turn any Netdata into a registry, edit <code class="highlighter-rouge">/etc/netdata/netdata.conf</code> and set:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[registry]
    enabled = yes
    registry to announce = http://&lt;netdata_host_ip&gt;:19999
    registry hostname = Master node #hostname used only in the registry
</code></pre></div></div>
<p>And now set the other netdata instances to advertise to that registry, edit again <code class="highlighter-rouge">/etc/netdata/netdata.conf</code> :</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[registry]
    enabled = no
    registry to announce = http://&lt;netdata_host_ip&gt;:19999
        registry hostname = Slave node #hostname used only in the registry
</code></pre></div></div>
<p>No additional configuration is required. Restart netdata and head over to the Dashboard to evaluate setup.</p>

<p>üìÉ<em>docs:</em> <a href="https://docs.netdata.cloud/registry/">https://docs.netdata.cloud/registry/</a></p>

<h2 id="backends-long-term-storage">Backends (Long-term Storage)</h2>

<p>Up until this point, netdata has been setup to save data for 1 week in the Master Node and for 1 day in the slave Node.</p>

<p>Remember that the slave‚Äôs database is been replicated to the Master Node, with retention period of 1 week.</p>

<p>To enable long-term historic data we will be using the backends functionality of netdata. According to the requirements, we will be using Prometheus to grab data from the Master Node and save it in a time-series long term database.</p>

<p>In essence, we will point <strong>Prometheus</strong> to <strong>netdata</strong> in order to fetch data and <strong>Grafana</strong> to <strong>Prometheus</strong> in order to visualise them.</p>

<p>We will set the Prometheus sampling at 3m, since for historic data 1s accuracy is not required.</p>

<h3 id="prometheus-installation">Prometheus Installation</h3>

<p>We will be installing Prometheus on the machine where the Netdata Master Node runs.</p>

<p>To install Prometheus run the following commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> curl <span class="nt">-s</span> https://api.github.com/repos/prometheus/prometheus/releases/latest <span class="se">\</span>
| <span class="nb">grep</span> <span class="s2">"browser_download_url.*linux-amd64.tar.gz"</span> <span class="se">\</span>
| <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">'"'</span> <span class="nt">-f</span> 4 <span class="se">\</span>
| wget <span class="nt">-qi</span> -

<span class="c"># create Prometheus user</span>
<span class="nb">sudo </span>useradd <span class="nt">-r</span> prometheus

<span class="c"># create prometheus directory</span>
<span class="nb">sudo mkdir</span> /opt/prometheus
<span class="nb">sudo chown </span>prometheus:prometheus /opt/prometheus

<span class="c"># Untar prometheus directory</span>
<span class="nb">sudo tar</span> <span class="nt">-xvf</span> /tmp/prometheus-<span class="k">*</span>linux-amd64.tar.gz <span class="nt">-C</span> /opt/prometheus <span class="nt">--strip</span><span class="o">=</span>1
</code></pre></div></div>
<h3 id="prometheus-configuration">Prometheus Configuration</h3>

<p>Prometheus is setup using <code class="highlighter-rouge">.yaml</code> .</p>

<ol>
  <li>run <code class="highlighter-rouge">touch prometheus.yaml</code></li>
  <li><code class="highlighter-rouge">sudo nano prometheus.yaml</code></li>
  <li>Copy the following configuration, replace NETDATA_IP with localhost:</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># my global config</span>
    <span class="na">global</span><span class="pi">:</span>
      <span class="na">scrape_interval</span><span class="pi">:</span>     <span class="s">3m</span> <span class="c1"># Set the scrape interval to every 5 seconds. Default is every 1 minute.</span>
      <span class="na">evaluation_interval</span><span class="pi">:</span> <span class="s">5s</span> <span class="c1"># Evaluate rules every 5 seconds. The default is every 1 minute.</span>
      <span class="c1"># scrape_timeout is set to the global default (10s).</span>
    
      <span class="c1"># Attach these labels to any time series or alerts when communicating with</span>
      <span class="c1"># external systems (federation, remote storage, Alertmanager).</span>
      <span class="na">external_labels</span><span class="pi">:</span>
          <span class="na">monitor</span><span class="pi">:</span> <span class="s1">'</span><span class="s">codelab-monitor'</span>
    
    <span class="c1"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span>
    <span class="na">rule_files</span><span class="pi">:</span>
      <span class="c1"># - "first.rules"</span>
      <span class="c1"># - "second.rules"</span>
    
    <span class="c1"># A scrape configuration containing exactly one endpoint to scrape:</span>
    <span class="c1"># Here it's Prometheus itself.</span>
    <span class="na">scrape_configs</span><span class="pi">:</span>
      <span class="c1"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span>
      <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">prometheus'</span>
    
        <span class="c1"># metrics_path defaults to '/metrics'</span>
        <span class="c1"># scheme defaults to 'http'.</span>
    
        <span class="na">static_configs</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">0.0.0.0:9090'</span><span class="pi">]</span>
    
      <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">netdata-scrape'</span>
    
        <span class="na">metrics_path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/api/v1/allmetrics'</span>
        <span class="na">params</span><span class="pi">:</span>
          <span class="c1"># format: prometheus | prometheus_all_hosts</span>
          <span class="c1"># You can use `prometheus_all_hosts` if you want Prometheus to set the `instance` to your hostname instead of IP </span>
          <span class="na">format</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">prometheus_all_hosts</span><span class="pi">]</span> <span class="c1">#stream both Master &amp; Slave node</span>
          <span class="c1">#</span>
          <span class="c1"># sources: as-collected | raw | average | sum | volume</span>
          <span class="c1"># default is: average</span>
          <span class="c1">#source: [as-collected]</span>
          <span class="c1">#</span>
          <span class="c1"># server name for this prometheus - the default is the client IP</span>
          <span class="c1"># for Netdata to uniquely identify it</span>
          <span class="c1">#server: ['prometheus1']</span>
        <span class="na">honor_labels</span><span class="pi">:</span> <span class="no">true</span>
    
        <span class="na">static_configs</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">targets</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">&lt;netdata_host_ip&gt;:19999'</span><span class="pi">]</span>
</code></pre></div></div>
<p><strong>Some notes on the configuration :</strong></p>

<ol>
  <li>We set the source as <code class="highlighter-rouge">average</code> which is the default setting. It means that Prometheus will store the average value of each interval (3m). If we set <code class="highlighter-rouge">as-collected</code>, we would be saving the exact value of each metric every 3 minutes.</li>
  <li><strong>Prometheus_all_hosts:</strong> It facilitates storage &amp; retrieval, since each metric is saved with a prefix depending on the host_machine from where it originated (remember, we have 2 machines).</li>
  <li>Prometheus needs only to point to the Master Node. Master Node will export both it‚Äôs databases.</li>
  <li>For all intents and purposes, we will be using the default settings for Prometheus</li>
</ol>

<h3 id="test-prometheus">Test Prometheus</h3>

<p>üëâüëâüëâüëâ Go to <code class="highlighter-rouge">[http://localhost:9090](http://localhost:9090)</code> to verify that everything is working.</p>

<p>Please don‚Äôt forget to verify that the system‚Äôs firewall allows prometheus to be accessed from the web. For more information, please refer back to the <a href="https://www.notion.so/odyslamtzidis/Netdata-guide-for-Production-Web-Server-Nginx-PHP-fpm-MariaDB-f17397f9c8524765bb06adec59aa2087#8bf84260bb0c47e8bdb17f5b006e097d">Firewall Section</a></p>

<p>You can read more in detail on how to setup Prometheus for more customised options at the docs:</p>

<p>üìÉ <a href="https://prometheus.io/docs/prometheus/latest/getting_started/">https://prometheus.io/docs/prometheus/latest/getting_started/</a></p>

<h3 id="prometheus-service">Prometheus Service</h3>

<p>Finally, it‚Äôs needed to create and install prometheus as a service. Follow the commands:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo touch</span> /etc/systemd/system/prometheus.service
<span class="nb">sudo </span>nano /etc/systemd/system/prometheus.service
</code></pre></div></div>
<p>and paste the following text inside the service file:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Prometheus Server
AssertPathExists=/opt/prometheus

[Service]
Type=simple
WorkingDirectory=/opt/prometheus
User=prometheus
Group=prometheus
ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml --log.level=info
ExecReload=/bin/kill -SIGHUP $MAINPID
ExecStop=/bin/kill -SIGINT $MAINPID

[Install]
WantedBy=multi-user.target
</code></pre></div></div>
<p>Finally</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start prometheus
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>prometheus
</code></pre></div></div>
<h3 id="prometheus-and-high-availability">Prometheus and High-Availability</h3>

<p>At this point, it is important to make a succinct note on Prometheus as a production-ready Long-Term Storage solution. In reality Prometheus is not intended to be used for long-term archiving, despite it‚Äôs efficiency (1.3 bytes/sample)  because it does not support High-Availability and Fault-Tolerance capabilities out of the box.</p>

<p>It is recommended for the user to research the following Open-Source projects that are placed <em>on top of Prometheus</em> and provide such functionality:</p>

<ul>
  <li>
    <p><strong>Thanos</strong>: <a href="https://thanos.io/">Thanos</a></p>
  </li>
  <li>
    <p><strong>Cortex</strong>: <a href="https://github.com/cortexproject">Cortex</a></p>
  </li>
  <li>
    <p><strong>M3</strong>: <a href="https://github.com/m3db/m3/">m3db/m3</a></p>
  </li>
</ul>

<hr />

<h3 id="grafana">Grafana</h3>

<p><strong>Installation</strong></p>

<p>The installation of Grafana is more straight forward, per the use-case and for easy management, the use of docker containers is advised.</p>

<p><strong>Install docker:</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>apt-transport-https ca-certificates curl software-properties-common

curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>apt-key add -

<span class="nb">sudo </span>add-apt-repository <span class="s2">"deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"</span>
<span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>docker-ce
</code></pre></div></div>
<p><strong>Run Grafana container:</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-p</span> 3000:3000  grafana/grafana
</code></pre></div></div>
<p>Note that using the above command, we run Grafana as a ‚Äúprogram‚Äù and it‚Äôs more about testing our setup, rather than deploying in for production.</p>

<p>In order to ensure that Grafana will <strong>always</strong> run, we need to make docker start on reboot, following the <a href="https://docs.docker.com/install/linux/linux-postinstall//#configure-docker-to-start-on-boot">Docker documentation</a> and then run the container using the following argument:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-i</span> <span class="nt">-p</span> 3000:3000 <span class="nt">--restart</span> unless-stopped  grafana/grafana
</code></pre></div></div>
<p><strong>Grafana Configuration</strong></p>

<p>Please don‚Äôt forget to verify that the system‚Äôs firewall allows Grafana to be accessed from the web. For more information, please refer back to the <a href="https://www.notion.so/odyslamtzidis/Netdata-guide-for-Production-Web-Server-Nginx-PHP-fpm-MariaDB-f17397f9c8524765bb06adec59aa2087#8bf84260bb0c47e8bdb17f5b006e097d">Firewall Section</a></p>

<ol>
  <li>Visit <a href="http://localhost:3000/%E2%80%99">http://localhost:3000/</a></li>
  <li>Login with <strong>username</strong>: Admin, <strong>Password</strong>: Admin</li>
  <li>Click <strong>Add data source</strong> and point it to Prometheus (<code class="highlighter-rouge">http://localhost:9090</code>)</li>
  <li>Finally, start by creating a new dashboard and adding graphs.</li>
</ol>

<p>üìÉMore information on starting with Grafana: <a href="https://grafana.com/docs/guides/getting_started/">https://grafana.com/docs/guides/getting_started/</a></p>

<h1 id="acknowledgement">Acknowledgement</h1>

<p>I would like to thank Spyros Konstantopoulos, System Administrator at the <a href="http://www.upatras.gr/en">University of Patras</a> and Dimitrios Giannopoulos, PhD student at the <a href="http://nam.ece.upatras.gr/">Network Architecture &amp; Management Group</a> of the <a href="http://www.ece.upatras.gr/index.php/el/">ECE department,</a> for their feedback and insightful comments on this work.</p>

<h1 id="comments">Comments</h1>

  </article>

	<p class="feed-recomendation">
		If you enjoyed this blog post, leave a comment here. You can't imagine how much I appreciate your feedback.
	</p>

  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'odyslam-me';
    var disqus_config = function () {
        this.page.url = "https://odyslam.me/Netdata-installation-production-web-server/";
        this.page.identifier = "";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  <script id="dsq-count-scr" src="//odyslam-me.disqus.com/count.js" async></script>
</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Love responsibility. Say: It is my duty, and mine alone, to save the earth. If it is not saved, then I alone am to blame.
    </footer>
  </div>
</div>


      </div>
    </body>
</html>
