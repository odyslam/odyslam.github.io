<!DOCTYPE html>
<html lang="pt">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Migrating from Nodebb to Discourse | blog.py</title>

    <!-- css, javascript, fonts -->
    <link rel="stylesheet" href="/blog/css/bootstrap-3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/blog/css/main.css?v=1.5">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100;0,400;0,600;1,100;1,300;1,400;1,423;1,500&family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-90109813-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-90109813-1');
</script>


    <link rel="shortcut icon" href="/blog/images/aperture.ico">
    <!-- Social tags  -->
    <meta property="og:title"
    content="
      Migrating from Nodebb to Discourse
    ">

    <meta property="og:description"
        content="
            Migrating a live forum from Nodebb to Discourse
        ">
    <meta name="description"
      content="
      Migrating a live forum from Nodebb to Discourse
        "
    >

    <meta property="og:url"
        content="https://odyslam.com/blog/Migrating-from-Nodebb-to-Discourse/" />

    <meta property="og:site_name" content="blog.py" />

    <meta property="og:locale" content="el_GR" />
    
    <meta name="twitter:site" content="@odysseas_lam" />
    
    <meta name="twitter:description" content="Migrating a live forum from Nodebb to Discourse" />
    
    
  <!-- Article specific OG data -->
  <!-- The OG:Type dictates a number of other tags on posts. -->
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2020-11-15 00:00:00 +0200" />

  <!-- page.modified isn't a natural Jekyll property, but it can be added. -->
  

  <!-- Article section isn't a required property, but it can be good to have -->
  <meta property="article:section" content="developer-relations" />

  <!-- I use the page.categories property for OG tags. -->
  

  <!-- I prefer the summary_large_image Twitter card for posts. -->
  <meta name="twitter:card" content="summary_large_image" />
  <!-- You, you're the creator. -->
  <meta name="twitter:creator" content="@odysseas_lam" />
  <!-- This property is for the article title, not site title. -->
  <meta name="twitter:title" content="Migrating from Nodebb to Discourse" />

  
    <meta property="og:image" content="https://i.imgur.com/hWeP9ld.png" />
    <meta name="twitter:image" content="https://i.imgur.com/hWeP9ld.png" />
  

  
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Migrating from Nodebb to Discourse | blog.py</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Migrating from Nodebb to Discourse" />
<meta name="author" content="Odysseas Lamtzidis" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Migrating a live forum from Nodebb to Discourse" />
<meta property="og:description" content="Migrating a live forum from Nodebb to Discourse" />
<link rel="canonical" href="https://odyslam.com/blog/Migrating-from-Nodebb-to-Discourse/" />
<meta property="og:url" content="https://odyslam.com/blog/Migrating-from-Nodebb-to-Discourse/" />
<meta property="og:site_name" content="blog.py" />
<meta property="og:image" content="https://i.imgur.com/hWeP9ld.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-15T00:00:00+02:00" />
<script type="application/ld+json">
{"datePublished":"2020-11-15T00:00:00+02:00","@type":"BlogPosting","dateModified":"2020-11-15T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://odyslam.com/blog/Migrating-from-Nodebb-to-Discourse/"},"image":"https://i.imgur.com/hWeP9ld.png","author":{"@type":"Person","name":"Odysseas Lamtzidis"},"description":"Migrating a live forum from Nodebb to Discourse","url":"https://odyslam.com/blog/Migrating-from-Nodebb-to-Discourse/","headline":"Migrating from Nodebb to Discourse","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


    <body>
      <div class="container">

        <header class="row">
  <div class="col-lg-8 col-lg-offset-2">
    print(<span class = "string">"You are browsing a blog that is hosted on <a style="font-weight:bold" target = "_blank" href = "https://i.imgur.com/4fwO5Kf.png">this</a>. In Greece."</span>)<br>
    <!-- print(<span class = "string">"Don't forget to subscribe üôè"</span>) -->
    <!-- <p>
            printf(<a href="https://." target="_blank"><span class="string">"https://<span class="reserved">%s</span>.<span class="reserved">\n</span>"</span></a>,nick);
        </p> -->
    <!-- <p>
    puts(<a href="/blogmisc/pubkey.gpg.txt" target="_blank"><span class="string">"5E12 9ABC C2A9 564B C048  2DF9 D327 0D10 BC71 CF75"</span></a>);
    <br> -->
  </p>
  </div>
</header>


<div class="row">
  <div class="col-lg-8 col-lg-offset-2">
    <div class="menu">
      <ul>
          <li><a target="_blank" href="https://odyslam.com">site_terminal.py</a></li>
          <li> | </li>
          <li><a href="/blog/">blog.py</a></li> 
          <li> | </li>
          <li><a target="_blank" href="https://twitter.com/odysseas_lam" target="_blank" >twitter</a></li>
          <li> | </li>
          <li> <a href="mailto:hi@odyslam.com">email</a></li>
          <li> | </li>
          <li><a target="_blank" href="odyslam.com/netdata/webserver"> netdata dashboard </a></li> 
      </ul>
    </div>
  </div>
</div>



        <div class="row">
          <div class="col-lg-8 col-lg-offset-2">
            <main>
            <div class="post">

  <header class="post-header">
    <h1>Migrating from Nodebb to Discourse</h1>
  </header>

  <article class="post-content">
  <div class="post">

  <header class="post-header">
    <p class="meta">
        Nov 15, 2020
         ‚Ä¢ Odysseas Lamtzidis
        
        ‚Ä¢
        <span><a href="/blog/category/#2020" class="reserved">2020</a>,</span><span><a href="/blog/category/#developer-relations" class="reserved">developer-relations</a>,</span><span><a href="/blog/category/#tutorial" class="reserved">tutorial</a></span>
    </p>
  </header>

  <article class="post-content">
  <p><img src="https://i.imgur.com/hWeP9ld.png" alt="" /></p>

<h1 id="migrating-from-nodebb-to-discourse">Migrating from Nodebb to Discourse</h1>

<p>In this blog post I note some interesting things that I discovered during the migration of the <a href="https://community.netdata.cloud">Netdata Community</a> from Nodebb to Discourse. I encountered an interesting bug and I had to deviate a bit from the <a href="https://meta.discourse.org/t/importing-nodebb-mongodb-to-discourse/126553/11">‚Äúofficial‚Äù instructions</a>, thus I thought it would be interesting to write some notes and share them.</p>

<p>Random stranger in the internet, I hope that this blog post saves you some time.</p>

<h1 id="some-background">Some background</h1>

<p>When I joined Netdata in early August, we had just released our forum, based on Nodebb.</p>

<p>According to Nodebb creators:</p>

<blockquote>
  <p>NodeBB is a next-generation discussion platform that utilizes web sockets for instant interactions and real-time notifications. NodeBB forums have many modern features out of the box such as social network integration and streaming discussions.</p>
</blockquote>

<p>The premise of a well-engineered product was proven true, as Nodebb is an extremely pleasant software to work with, offering a modern technological stack which is easily extensible and using npm to vendor it‚Äôs plugins.</p>

<p>On top of that, the plugins can be installed without rebuilding the forum, meaning that you can swap them on-the-fly. Great!</p>

<p>The reason we chose to move out of Nodebb is that although the project is awesome and the community is vivid, it‚Äôs not as popular as Discourse. This translates to Discourse having a greater number of available plugins and themes. Our community quickly grew with new requirements that would be hard to accommodate with the existing tools at hand.</p>

<p>In other words, in order to bring the forums up to shape, there is more manual work and maintenance required in Nodebb than in Discourse. Which would have been great, since the choice of customization is really wonderful, but I am the only Developer Relations team member at the moment. Thus whatever development I need, I will do it myself, limiting considerably the time I can invest.</p>

<p>Moreover, as I have now spent considerable time in Discourse, while I do prefer some elements of NodeBB, such as the technology stack or the plugin system; Discourse as a whole offers much more control and options.** It‚Äôs simply more mature.**</p>

<p>All in all, there is a reason while the grand majority of forums look identical nowadays, and the reason is that Discourse is hard to beat. (Although there are a couple of interesting options oriented more for SaaS  products, maybe in another blog post)</p>

<h2 id="the-migration">The migration</h2>

<p>In order to migrate, the good folks at Discourse, with the <a href="https://meta.discourse.org/t/importing-nodebb-mongodb-to-discourse/126553/11">help of the community</a>, have released a migration tool which parses the MongoDB/Redis database of Nodebb and extracts what can be extracted.</p>

<p>There are a few gotchas which I learned the hard way. Let‚Äôs see them:</p>

<ol>
  <li>You have to build Discourse from source. As it‚Äôs a great piece of monolithic software on Ruby, it‚Äôs not as trivial as one would have hoped.
    <ol>
      <li>MacOS is not playing nice with Ruby, avoid to reduce unneeded complexity.</li>
      <li>Go for Ubuntu (or an Ubuntu VM) and prepare to spend quite some time in order to setup everything.</li>
    </ol>
  </li>
  <li>In case of a hosted NodeBB, make sure that you request the <strong>entirety</strong> of the dump from their support . I spent quite some time trying to figure out why the migration did not work and the reason was that I simply requested half the dump.</li>
  <li>In case you encounter the <code class="highlighter-rouge">don't know what to do with file, skipping</code> error, it means that you are using a newer version of mongorestore which has a slightly  different syntax than the one that is shown in the migration instructions.
    <ol>
      <li>Try <code class="highlighter-rouge">mongorestore -d &lt;database_name&gt; /directory</code></li>
      <li>This will restore the database in a newly created database called <code class="highlighter-rouge">&lt;database_name&gt;</code>.</li>
      <li>Make sure you change the <code class="highlighter-rouge">nodebb.rb</code> line concerning the connection to the MongoDB to include the database you defined above: <code class="highlighter-rouge">@client = adapter.new('mongodb://127.0.0.1:27017/&lt;database_name&gt;'')</code></li>
    </ol>
  </li>
  <li>It is possible that NodeBB has created some orphan posts or another bad state inside the database. These abnormalities can break the migration script, bringing the process to a halt. This is what happened to my case and it‚Äôs the crux of this blog post.</li>
</ol>

<h2 id="the-culprit-is-314">The culprit is 3.14</h2>

<p>I used to get some bad states in the forum, meaning that some topics would be created they would be impossible to be retrieved after their creation, resulting to a 404 instead.</p>

<p>As there were already internal discussions about the migration from NodeBB to another platform, I did not spend time to pin down the issue, as it was very very intermittent and I had a myriad other things to look after.</p>

<p>After some time, I discovered that the reason for this was the keyword <code class="highlighter-rouge">Raspberry pi</code> in the topic name. Every time a topic name included that keyword, the whole topic would enter a bad state, with 404 every single time and manual deletion of the topic (or change of the topic name) as the only solution.</p>

<p>Again, I did not elect to debug the issue any further. That was a mistake.</p>

<h3 id="we-found-it">We found it!</h3>

<p>After talking with the good folks at NodeBB for this migration, I informed them of the bug, in case they wanted to dig deeper to evaluate if this is a wider problem or specific to my instance. They were very happy to investigate, and indeed they found the culprit.</p>

<p>They use a specific regex on their reverse proxy that checks for common file extensions that they don‚Äôt serve. One of these files is <code class="highlighter-rouge">.asp</code> which without the ^ or $ qualifier can match with <code class="highlighter-rouge">raspberry pi</code>. By updating their rules, they were able to fix this.</p>

<p>But, even with finding the culprit, the bad states had been created inside the database and unknowingly to me, they would come back and haunt me during the migration.</p>

<h2 id="the-migration-1">The migration</h2>

<p>When I tried to test the migration, the script was unable to perform the migration and would crash, consistently and without giving much information. With the help of some debugging ‚Äúprint‚Äù statements that I put in the script, I found that the script would crash in area of topics import.</p>

<p>At first, it fetches a list of topics, then it starts pulling each topic from the database, and for each topic it pulls all it‚Äôs posts.</p>

<p>It‚Äôs simple really.</p>

<p>But, to my disappointment, the script would crash when it it tried to pull the post of a particular topic, the one with the <code class="highlighter-rouge">raspberry pi</code> keyword in it‚Äôs title.</p>

<p>When I tried to fetch the topic from the database, using MongoCLI, I was successful, but when I tried to fetch the first post of that particular topic, I couldn‚Äôt.</p>

<p><strong>Bingo!</strong></p>

<p>Apparently, for the <code class="highlighter-rouge">Raspberry pi</code> topics, while the topic existed, the post did not, resulting in a <code class="highlighter-rouge">null</code> return for <code class="highlighter-rouge">post_id</code> and the crashing of the whole script. In Nodebb, the <code class="highlighter-rouge">post_id</code> of the first post of a topic, is the <code class="highlighter-rouge">mainPID</code>.</p>

<p>Here is the data structure of the bad topic:</p>
<pre><code class="language-JSON">{
    "_id": ObjectId("5f621635d53e46aab957f13b"),
    "_key": "topic:99",
    "cid": 3,
    "lastposttime": 1600263733946,
    "mainPid": 0,
    "postcount": 0,
    "slug": "99/monitor-pi-hole-and-a-raspberry-pi-with-netdata",
    "tid": 99,
    "timestamp": 1600263733946,
    "title": "Monitor Pi-hole (and a Raspberry Pi) with Netdata",
    "uid": 3,
    "viewcount": 2,
    "thumb": "",
    "deleted": 1,
    "deletedTimestamp": 1600263902138,
    "deleterUid": 37,
    "mergeIntoTid": 100,
    "mergedTimestamp": 1600263902160,
    "mergerUid": 37
}
</code></pre>
<p>Now that I knew the exact problem, I had to think of a quick solution.</p>

<p>Here is the function in <code class="highlighter-rouge">mongo.rb</code> that fetches the list of topics from MongoDB.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">topics</span><span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_size</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">)</span>
      <span class="n">topic_keys</span> <span class="o">=</span> <span class="n">mongo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="ss">_key: </span><span class="s1">'topics:tid'</span><span class="p">).</span><span class="nf">skip</span><span class="p">(</span><span class="n">offset</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="n">page_size</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:value</span><span class="p">)</span>
      <span class="n">topic_keys</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">topic_key</span><span class="o">|</span> <span class="n">topic</span><span class="p">(</span><span class="n">topic_key</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>I assumed that if I removed the particular topic from that list of available topics, even if it exists in the database, the script will not try to import it and thus the migration will succeed.</p>

<p>I ran: <code class="highlighter-rouge">db.objects.find({_key:"topics:tid"})</code> which returned a large number of documents, like this one: <code class="highlighter-rouge">{ "_id" : ObjectId("5fb48402d53e46aab9f70b07"), "_key" : "topics:tid", "value" : "198", "score" : 1605665794715 }</code>.</p>

<p>Thus, I needed to delete the document with <code class="highlighter-rouge">"value":"99"</code> by running <code class="highlighter-rouge">db.objects.remove({_key:"topics:tid", "value": "99"})</code> and <em>voila</em>, the migration script was able to progress normally.</p>

<p>In case you are interested, you can find the database schema on the NodeBB <a href="https://docs.nodebb.org/development/database-structure/">website</a>.</p>

<p>Here are the steps for the migration in a bite-sized format:</p>
<ol>
  <li>Import mongodump into local instance of Mongo.</li>
  <li>Build Discourse from source and setup the discourse instance.</li>
  <li>Run script which exports data from mongo, transforms them and import them to PostgreSQL.</li>
  <li>Export Discourse instance through the Admin panel and import it to the production server.
    <ol>
      <li>In case you are using a Hosted version of Discourse, you will need to contact support in order to restore the uploaded backup.</li>
    </ol>
  </li>
  <li>Make modifications and prepare forum for production use.</li>
</ol>

<h1 id="final-words">Final words</h1>

<p>A last problem that I encountered during the migration was related with the profile pictures that the script tried to import. Apparently some were pulled from the Internet and used some special characters which the script could not parse.</p>

<p>As with the <a href="https://www.investopedia.com/terms/p/paretoprinciple.asp">Pareto Principle</a> of 80/20, I am pretty happy with a 80% of the perfect result by investing only the 20% of total effort. I simply <em>commented-out</em> the profile picture functions and went on with my life, and the migration.</p>

<p>Although this will result in a <em>worse</em> user experience, as existing users will have to re-upload their profile pictures, the other option was not viable as I would have to understand what is the exact issue and change the script, possibly learning some Ruby in the process. I simply don‚Äôt have the time.</p>

<p>Due to creating the foundations of a Developer Relations program, I have to be ruthless with prioritization, something which I have not done particularly successfully. But, as it‚Äôs a process, I learn continuously, and thus I opted to go for the quick-and-dirty solution for this.</p>

<p>In the end, what really matters is to improve the experience of the community as a whole, making sure that it grows steadily.</p>

  </article>



</div>

  </article>

</div>

            </main>
          </div>
        </div>

        <br>
<iframe src="https://odysseas.substack.com/embed" width="480" height="320" style="border:1px solid #EEE; background:white;" frameborder="0" scrolling="no"></iframe>
    <!--End mc_embed_signup-->
    <br>
    
    <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'odyslam-me';
    var disqus_config = function () {
        this.page.url = "https://odyslam.com/Migrating-from-Nodebb-to-Discourse/";
        this.page.identifier = "";
    };
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



    
    <script id="dsq-count-scr" src="//odyslam-me.disqus.com/count.js" async></script>
  <div class="col-lg-8 col-lg-offset-2">
    <footer>
      Love responsibility. Say: It is my duty, and mine alone, to save the earth. If it is not saved, then I alone am to blame. <br> - Nikos Kazantzakis, Ascetica   
    </footer>
  </div>
</div>


      </div>
    </body>
</html>
